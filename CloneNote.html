<!DOCTYPE HTML>
<html>

<head>
    <!-- Include stylesheet -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        #editor {
            all: revert;
            margin: 0;
        }

        .editor-layout {
            width: 80%;
            height: calc(100vh - 43px);
            flex-grow: 10;
            box-shadow: 0px 0px 6px grey;
        }

        #maincontent {
            display: flex;
            flex-direction: row;
            height: calc(100vh - 43px);
            /* margin-top: 40px; */
            box-sizing: border-box;
        }

        #pages {
            flex-grow: 1;
            margin-right: 10px;
        }

        #leftspacer {
            width: 10px;
        }

        body,
        html {
            margin: 0;
            height: calc(100vh - 40px);
        }

        #toolbarcontainer {
            display: flex;
            box-sizing: border-box;
            position: absolute;
            top: 0px;
            height: 30px;
            width: 100vw;
            margin-top: 3px;
            border: none;
        }

        #spacer {
            margin-top: 33px;
            height: 10px;
            box-sizing: border-box;
            border: none;
        }

        .save-button {
            margin-left: auto;
        }

        .tab {
            /* Green */
            all: revert;
            font-family: Helvetica, Arial, sans-serif;
            box-sizing: border-box;
            border: none;
            color: black;
            padding: 5px 10px;
            text-align: center;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
        }

        #pagecontainer {
            all: revert;
        }

        .page,
        .new-page-button {
            font-family: Helvetica, Arial, sans-serif;
            box-sizing: border-box;
            font-size: small;
            padding-left: 10px;
            padding-top: 5px;
            padding-bottom: 5px;
            padding-right: 10px;
            border-top-right-radius: 5px;
            border-bottom-right-radius: 5px;
        }

        .new-page-button {
            margin-top: 5px;
            color: grey;
        }

        .new-page-button:active {
            color: black;
        }

        .notebook-name-class {
            font-family: Helvetica, Arial, sans-serif;
            box-sizing: border-box;
            text-align: center;
            padding-left: 5px;
            padding-right: 15px;
            margin-top: auto;
            margin-bottom: auto;
            border-right: 1px solid lightgray;
        }

        #tabcontainer {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: row;
        }

        .save-button,
        .load-button {
            font-family: Helvetica, Arial, sans-serif;
            font-size: small;
            box-sizing: border-box;
            text-align: center;
            color: grey;
            padding: 5px 5px;
            margin-top: auto;
            margin-bottom: auto;
        }

        .load-button {
            margin-right: 10px;
        }

        .new-button {
            font-family: Helvetica, Arial, sans-serif;
            font-size: small;
            box-sizing: border-box;
            text-align: center;
            color: grey;
            padding: 5px 5px;
            margin-left: 10px;
            margin-top: auto;
            margin-bottom: auto;
            border-top-left-radius: 5px;
        }

        .save-button:active,
        .load-button:active,
        .new-button:active {
            color: black;
        }

        #inp {
            position: absolute;
            top: 0px;
            left: 0px;
            z-index: -10;
        }

        .context-menu {
            position: absolute;
            text-align: center;
            background: white;
            border: 1px solid grey;
        }

        .context-menu ul {
            padding: 0px;
            margin: 0px;
            list-style: none;
        }

        .context-menu ul li {
            padding-bottom: 5px;
            padding-top: 5px;
            padding-left: 5px;
            padding-right: 5px;
            border: none;
            font-family: Helvetica, Arial, sans-serif;
        }

        .context-menu ul li:hover {
            background: lightgray;
        }

        .ql-toolbar.ql-snow {
            border: none !important;
            border-bottom: 1px lightgrey !important;
        }
    </style>
    <title>CloneNote</title>
</head>

<body onload="setup()">
    <!-- Navigation tabs -->
    <!-- Actions - single click to switch to that tab -->
    <!-- Double click to rename tab -->
    <!-- + button creates new tab with open name field -->
    <!-- save/load aligned to the right -->
    <div id="toolbarcontainer">
        <div id="notebookname" class="notebook-name-class">
        </div>
        <div id="tabcontainer">
        </div>
        <div class="new-button" onclick="newTab()">Add Tab</div>
        <div class="save-button" onclick="save()">Save</div>
        <div class="load-button" onclick="load()">Load</div>
    </div>

    <div id="spacer"></div>

    <!-- Create the editor container -->
    <div id="maincontent">
        <div id="leftspacer"></div>
        <div class="editor-layout">
            <div id="editor"></div>
        </div>
        <div id="pagecontainer">
            <div id="pages">
            </div>
            <div class='new-page-button' onclick="newPage()">Add Page</div>
        </div>
    </div>

    <!-- This is for file saving -->
    <input id="inp" type='file' style="visibility:hidden;" onchange="readFile(event)" />

    <!-- Context menu for rename/delete -->
    <div id="contextMenu" class="context-menu" style="display:none">
        <ul>
            <li onclick="renameItem()">Rename</li>
            <li onclick="deleteItem()">Delete</li>
        </ul>
    </div>

    <!-- Include the Quill library -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <!-- FileSaver.js-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- Initialize Quill editor -->
    <script>
        var Delta = Quill.import('delta');

        // State contained in notebook array and notebook.activeTab variable
        var notebook = {
            activeTab: 0,
            notebookName: "Your Notebook",
            tabs: [{
                name: "Home",
                activePage: 0,
                pages: [{
                    name: "First Page",
                    content: [
                        { insert: 'Welcome to CloneNote!\n' },
                        { insert: 'Use Save and Load to save notebooks to json and load them from disk\n' },
                    ]
                }]
            }]
        };

        const tabColors = [ "#BF633080", "#E3A92480", "#DED8B680", "#86C1A580", "#62518580"]

        // fancy toolbar
        var toolbarOptions = [
            ['bold', 'italic', 'underline', 'strike'],        // toggled buttons
            ['blockquote', 'code-block'],

            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
            [{ 'script': 'sub' }, { 'script': 'super' }],      // superscript/subscript

            [{ 'size': ['small', false, 'large', 'huge'] }],  // custom dropdown
            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],

            [{ 'color': [] }, { 'background': [] }],          // dropdown with defaults from theme
            [{ 'font': [] }],
            [{ 'align': [] }],
            ['link', 'image'],

            ['clean']                                         // remove formatting button
        ];

        var quill = new Quill('#editor', {
            modules: {
                toolbar: toolbarOptions
            },
            theme: 'snow'
        });

        // loads notebook into html elements
        function loadNotebook() {
            // set editor content
            var currentTab = notebook.tabs[notebook.activeTab];
            var content = currentTab.pages[currentTab.activePage].content;
            quill.setContents(content);

            // clear tabs
            var tabcontainer = document.getElementById('tabcontainer');
            while (tabcontainer.firstChild) {
                tabcontainer.removeChild(tabcontainer.firstChild);
            }          

            // set notebook name
            document.getElementById('notebookname').innerText = notebook.notebookName;
            document.getElementById('notebookname').addEventListener('contextmenu', showMenu);
            document.getElementById('notebookname').addEventListener('input', setNotebookName);

            // Load tabs into tabcontainer
            for (var tab of notebook.tabs) {
                const tabLabel = document.createElement('div');
                tabLabel.setAttribute('onClick', 'openTab(this)');
                tabLabel.setAttribute('onDblClick', 'renameTab(this)');
                tabLabel.addEventListener('contextmenu', showMenu);
                tabLabel.addEventListener('input', setTabName);
                tabLabel.setAttribute('class', 'tab');
                const title = document.createTextNode(tab.name);
                const tabcontainer = document.getElementById('tabcontainer');
                tabLabel.appendChild(title);
                tabcontainer.appendChild(tabLabel);
            }

            // Make active tab bold
            //tabcontainer.children[notebook.activeTab].style.fontWeight = 'bold';
            // Give active tab some box shadow to the left and right
            tabcontainer.children[notebook.activeTab].style.boxShadow = '0px 0px 6px lightgrey';
            tabcontainer.children[notebook.activeTab].style.clipPath = 'inset(-6px -6px 0 -6px)';


            // Clear pages
            var pagesDiv = document.getElementById('pages');
            while (pagesDiv.firstChild) {
                pagesDiv.removeChild(pagesDiv.firstChild);
            }  

            // Load page divs into #pages container div
            for (var page of currentTab.pages) {
                const newPage = document.createElement('div');
                newPage.setAttribute('class', 'page');
                newPage.setAttribute('onClick', 'openPage(this)');
                newPage.setAttribute('onDblClick', 'renamePage(this)');
                newPage.addEventListener('input', setPageName);
                newPage.addEventListener('contextmenu', showMenu);
                const pageName = document.createTextNode(page.name);
                newPage.appendChild(pageName);
                pagesDiv.appendChild(newPage);
            }

            // make active page bold
            pagesDiv.children[currentTab.activePage].style.backgroundColor = 'white';
            pagesDiv.children[currentTab.activePage].style.boxShadow = '0px 0px 6px grey';
            pagesDiv.children[currentTab.activePage].style.clipPath = 'inset(-6px -6px -6px 0px)';

            // set colors
            var color = tabColors[notebook.activeTab % tabColors.length];
            var spacer = document.getElementById('spacer');
            tabcontainer.children[notebook.activeTab].style.backgroundColor = color;
            spacer.style.backgroundColor = color;
            var leftspacer = document.getElementById('leftspacer');
            var pagecontainer = document.getElementById('pagecontainer');
            pagecontainer.style.backgroundColor = color;
            leftspacer.style.backgroundColor = color;
        }

        // load default tab into editor
        function setup() {
            loadNotebook();
        }

        // context menu functions
        document.onclick = hideMenu;
        function hideMenu(keepContentEditable) {
            console.log('calling hidemenu', keepContentEditable);
            document.getElementById('contextMenu').style.display = 'none';
            // also set all contenteditable items to false
            if (keepContentEditable === true) {
                for (var element of document.getElementsByClassName('tab')) {
                    element.setAttribute("contenteditable", false);
                }
                for (var element of document.getElementsByClassName('page')) {
                    element.setAttribute("contenteditable", false);
                }
            }
        }

        function showMenu(e) {
            e.preventDefault();
            var menu = document.getElementById("contextMenu")

            if (menu.style.display == "block") {
                hideMenu(true);
            }
            else {
                menu.style.display = 'block';
                menu.style.left = e.pageX + 'px';
                menu.style.top = e.pageY + 'px';
            }
        }

        function renameItem() {
            // figure out what element is below top left corner of context menu
            // document.elementFromPoint to grab element
            var menuRect = document.getElementById('contextMenu').getBoundingClientRect();
            var elementsUnder = document.elementsFromPoint(menuRect.left, menuRect.top);
            for (var element of elementsUnder) {
                if (element.className == 'tab' || element.className == 'page' || element.className == 'notebook-name-class') {
                    element.setAttribute("contenteditable", true);
                    element.focus();
                }
            }
        }

        function deleteItem() {
            console.log('calling deleteItem')
            var menuRect = document.getElementById('contextMenu').getBoundingClientRect();
            var elementsUnder = document.elementsFromPoint(menuRect.left, menuRect.top);
            const tabcontainer = document.getElementById('tabcontainer');
            const pagecontainer = document.getElementById('pages');
            for (var element of elementsUnder) {
                if (element.className == 'tab') {
                    var tabindex = Array.prototype.indexOf.call(tabcontainer.children, element);
                    if (notebook.tabs.length != 1) {
                        notebook.tabs.splice(tabindex, 1);
                        if (tabindex == notebook.activeTab && tabindex != 0) {
                            notebook.activeTab -= 1;
                        }
                    }
                }
                if (element.className == 'page') {
                    var pageindex = Array.prototype.indexOf.call(pagecontainer.children, element);
                    console.log('deleting page at index', pageindex);
                    console.log('old pages', JSON.stringify(notebook.tabs[notebook.activeTab].pages))
                    if (notebook.tabs[notebook.activeTab].pages.length != 1) {
                        notebook.tabs[notebook.activeTab].pages.splice(pageindex, 1);
                        if (pageindex == notebook.tabs[notebook.activeTab].activePage && pageindex != 0) {
                            notebook.tabs[notebook.activeTab].activePage -= 1;
                        }
                    }
                    console.log('new pages', JSON.stringify(notebook.tabs[notebook.activeTab].pages))
                }
            }
            loadNotebook();
        }

        function setNotebookName(e) {
            notebook.notebookName = e.path[0].innerText;
        }

        function renameTab(elem) {
            elem.setAttribute("contenteditable", true);
        }

        // Change tab name when input to span element is changed (fires on every character)
        function setTabName(e) {
            notebook.tabs[notebook.activeTab].name = e.path[0].innerText;
        }

        // save the current editor contents in notebook page and load new content
        function openTab(elem) {
            if (elem.getAttribute("contenteditable") != false) {
                // save current page to delta
                var tab = notebook.tabs[notebook.activeTab];
                console.log(tab);
                tab.pages[tab.activePage].content = quill.getContents();

                // get new active tab
                const tabcontainer = document.getElementById('tabcontainer');
                notebook.activeTab = Array.prototype.indexOf.call(tabcontainer.children, elem);

                loadNotebook();
            }
        }

        // Create new HTML elements for a tab, set default values, and add to notebook array
        function newTab() {
            console.log('clicked on create new tab');
            notebook.tabs.push({
                name: "New Tab",
                activePage: 0,
                pages: [{
                    name: "First Page",
                    content: [
                        { insert: '\n' },
                    ]
                }]
            });
            const tab = document.createElement('div');
            tab.setAttribute('onClick', 'openTab(this)');
            tab.setAttribute('onDblClick', 'renameTab(this)');
            tab.addEventListener('input', setTabName);
            tab.addEventListener('contextmenu', showMenu);
            tab.setAttribute('class', 'tab');
            const title = document.createTextNode('New Tab');
            const tabcontainer = document.getElementById('tabcontainer');
            tab.appendChild(title);
            tabcontainer.appendChild(tab);
        }

        function renamePage(elem) {
            console.log('calling renamePage')
            console.log(elem);
            elem.setAttribute("contenteditable", true);
        }

        // Change tab name when input to span element is changed (fires on every character)
        function setPageName(e) {
            console.log('in setPageName')
            notebook.tabs[notebook.activeTab].pages[notebook.tabs[notebook.activeTab].activePage].name = e.path[0].innerText;
        }

        function openPage(elem) {
            if (elem.getAttribute("contenteditable") != true) {
                // save editor to current activePage
                var tab = notebook.tabs[notebook.activeTab];
                tab.pages[tab.activePage].content = quill.getContents();

                // get new active page
                const pageContainer = document.getElementById('pages');
                tab.activePage = Array.prototype.indexOf.call(pageContainer.children, elem);

                loadNotebook();
            }
        }

        function newPage() {
            notebook.tabs[notebook.activeTab].pages.push({
                name: "New Page",
                content: [
                    { insert: '\n' },
                ]
            });
            loadNotebook();
        }

        // save to json
        function save() {
            console.log('pressed save button');
            var notebookText = JSON.stringify(notebook);
            var blob = new Blob([notebookText], { type: "application/json;charset=utf-8" });
            saveAs(blob, notebook.notebookName + '.json');
        }

        // load from json
        // Need to use a hidden input element to trigger the event
        function load() {
            console.log('pressed load button');
            document.getElementById('inp').click();
        }

        // Handle readFile event
        function readFile(e) {
            var file = e.target.files[0];
            var reader = new FileReader();
            reader.onload = function (e) {
                notebook = JSON.parse(e.target.result);
                loadNotebook();
            }
            reader.readAsText(file);
        }
    </script>
</body>

</html>